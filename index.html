<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isolation Gown Inventory Manager - Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <div id="app" class="p-8">
        <div class="max-w-5xl mx-auto">
            <div class="bg-white rounded-lg shadow-xl p-8 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        <h1 class="text-3xl font-bold text-gray-800">Isolation Gown Inventory Manager</h1>
                        <span class="px-3 py-1 bg-green-100 text-green-800 text-xs font-bold rounded-full">üîÑ LIVE SYNC</span>
                    </div>
                    <button id="logoutBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition hidden">Logout</button>
                </div>

                <div id="statusBadge" class="mb-4 p-3 bg-blue-100 text-blue-800 rounded-lg text-sm font-medium hidden">üîÑ Connecting...</div>
                <div id="messageBox" class="hidden mb-4 p-4 rounded-lg flex items-center gap-2"></div>

                <div id="pinStep" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Enter PIN Code (ËæìÂÖ•PINÁ†Å)</label>
                        <input type="password" id="pinInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Enter PIN" autofocus>
                    </div>
                    <button onclick="handlePinSubmit()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">Submit</button>
                </div>

                <div id="actionStep" class="space-y-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Action</label>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="selectAction('add')" class="px-6 py-8 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium text-lg">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Add (Ê∑ªÂä†)
                        </button>
                        <button onclick="selectAction('delete')" class="px-6 py-8 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium text-lg">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            Delete (Âà†Èô§)
                        </button>
                    </div>
                </div>

                <div id="lotNumberStep" class="space-y-4 hidden">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Lot Number (ÊâπÊ¨°Âè∑)</label>
                        <input type="text" id="lotNumberInput" class="w-full px-4 py-2 border rounded-lg" placeholder="e.g., HX26010501"></div>
                    <button onclick="handleLotNumberSubmit()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Next</button>
                </div>

                <div id="sizeStep" class="space-y-4 hidden">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Size: Large or Extra Large</label>
                        <input type="text" id="sizeInput" class="w-full px-4 py-2 border rounded-lg" placeholder="L or XL"></div>
                    <div class="flex gap-3">
                        <button onclick="goBack()" class="w-1/3 px-4 py-2 bg-gray-500 text-white rounded-lg">Back</button>
                        <button onclick="handleSizeSubmit()" class="w-2/3 px-4 py-2 bg-indigo-600 text-white rounded-lg">Next</button>
                    </div>
                </div>

                <div id="palletStep" class="space-y-4 hidden">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Amount of Pallets</label>
                        <input type="number" id="palletInput" class="w-full px-4 py-2 border rounded-lg" placeholder="Enter number"></div>
                    <div class="flex gap-3">
                        <button onclick="goBack()" class="w-1/3 px-4 py-2 bg-gray-500 text-white rounded-lg">Back</button>
                        <button onclick="handlePalletSubmit()" class="w-2/3 px-4 py-2 bg-indigo-600 text-white rounded-lg">Next</button>
                    </div>
                </div>

                <div id="completedStep" class="space-y-4 hidden">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Is it completed? Yes/No</label>
                        <input type="text" id="completedInput" class="w-full px-4 py-2 border rounded-lg" placeholder="Yes or No"></div>
                    <div class="flex gap-3">
                        <button onclick="goBack()" class="w-1/3 px-4 py-2 bg-gray-500 text-white rounded-lg">Back</button>
                        <button onclick="handleCompletedSubmit()" class="w-2/3 px-4 py-2 bg-indigo-600 text-white rounded-lg">Update</button>
                    </div>
                </div>

                <div id="deleteStep" class="space-y-4 hidden">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Lot Number</label>
                        <input type="text" id="deleteLotInput" class="w-full px-4 py-2 border rounded-lg" placeholder="e.g., HX26010501"></div>
                    <button onclick="handleDeleteLotSubmit()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg">Next</button>
                </div>

                <div id="deleteSizeStep" class="space-y-4 hidden">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Size: L or XL</label>
                        <input type="text" id="deleteSizeInput" class="w-full px-4 py-2 border rounded-lg" placeholder="L or XL"></div>
                    <div class="flex gap-3">
                        <button onclick="goBackDelete()" class="w-1/3 px-4 py-2 bg-gray-500 text-white rounded-lg">Back</button>
                        <button onclick="handleDeleteSizeSubmit()" class="w-2/3 px-4 py-2 bg-indigo-600 text-white rounded-lg">Next</button>
                    </div>
                </div>

                <div id="deletePalletStep" class="space-y-4 hidden">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Pallets to Remove</label>
                        <input type="number" id="deletePalletInput" class="w-full px-4 py-2 border rounded-lg" placeholder="Enter number"></div>
                    <div class="flex gap-3">
                        <button onclick="goBackDelete()" class="w-1/3 px-4 py-2 bg-gray-500 text-white rounded-lg">Back</button>
                        <button onclick="handleDeletePalletSubmit()" class="w-2/3 px-4 py-2 bg-red-600 text-white rounded-lg">Delete</button>
                    </div>
                </div>
            </div>

            <div id="inventorySection" class="bg-white rounded-lg shadow-xl p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Current Inventory (ÂÆûÊó∂ÂêåÊ≠•)</h2>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="downloadCSV()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">Download</button>
                        <button onclick="clearAllInventory()" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm">Clear All</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left">Lot Number</th>
                                <th class="px-3 py-2 text-left">Mfg Date</th>
                                <th class="px-3 py-2 text-left">Use-By</th>
                                <th class="px-3 py-2 text-left">Qty (L)</th>
                                <th class="px-3 py-2 text-left">Qty (XL)</th>
                                <th class="px-3 py-2 text-left">Pallet (L)</th>
                                <th class="px-3 py-2 text-left">Pallet (XL)</th>
                                <th class="px-3 py-2 text-left">Total</th>
                                <th class="px-3 py-2 text-left">Note</th>
                                <th class="px-3 py-2 text-left">Edit</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCN1ZTORnEq58p2QkoLijAwvS6mYXBNZw0",
            authDomain: "pallets-inventory.firebaseapp.com",
            databaseURL: "https://pallets-inventory-default-rtdb.firebaseio.com",
            projectId: "pallets-inventory",
            storageBucket: "pallets-inventory.firebasestorage.app",
            messagingSenderId: "759793014443",
            appId: "1:759793014443:web:69fea877162ffa23d509ee"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.db = db;

        const badge = document.getElementById('statusBadge');
        badge.classList.remove('hidden');
        setTimeout(() => {
            badge.textContent = '‚úÖ Connected to Firebase!';
            badge.classList.remove('bg-blue-100', 'text-blue-800');
            badge.classList.add('bg-green-100', 'text-green-800');
            setTimeout(() => badge.classList.add('hidden'), 2000);
        }, 500);

        const inventoryRef = ref(db, 'inventory');
        onValue(inventoryRef, (snapshot) => {
            const data = snapshot.val();
            window.state.inventory = data ? Object.values(data) : [];
            if (window.state.isAuthenticated) {
                window.renderTable();
            }
        });

        window.saveToFirebase = function() {
            set(inventoryRef, window.state.inventory);
        };
    </script>

    <script>
        window.state = {
            isAuthenticated: false,
            currentStep: 'pin',
            currentAction: '',
            lotNumber: '',
            size: '',
            palletAmount: '',
            isCompleted: '',
            deleteLotNumber: '',
            deleteSize: '',
            deletePalletAmount: '',
            inventory: []
        };

        function showMessage(msg, type) {
            const box = document.getElementById('messageBox');
            box.className = `mb-4 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            box.textContent = msg;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 4000);
        }

        function showStep(step) {
            ['pinStep', 'actionStep', 'deleteStep', 'deleteSizeStep', 'deletePalletStep', 'lotNumberStep', 'sizeStep', 'palletStep', 'completedStep'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(step + 'Step').classList.remove('hidden');
            
            if (step !== 'pin') {
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('inventorySection').classList.remove('hidden');
            }
        }

        function parseLotNumberDates(lotNum) {
            if (lotNum.length < 8) return { mfgDate: '', useByDate: '' };
            
            // Extract first 6 digits after 'HX': YYMMDD
            // Example: HX26020301 -> 260203 -> 02/03/2026
            const yearPart = lotNum.substring(2, 4);   // "26"
            const monthPart = lotNum.substring(4, 6);  // "02"
            const dayPart = lotNum.substring(6, 8);    // "03"
            
            const year = 2000 + parseInt(yearPart);    // 2026
            const month = parseInt(monthPart);         // 2
            const day = parseInt(dayPart);             // 3
            
            const mfgDate = `${month}/${day}/${year}`;
            const useByDate = `${month}/${day}/${year + 3}`;
            
            return { mfgDate, useByDate };
        }

        window.renderTable = function() {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = window.state.inventory.map((item, i) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-3 py-2 font-medium">${item.lotNumber}</td>
                    <td class="px-3 py-2">${item.mfgDate}</td>
                    <td class="px-3 py-2">${item.useByDate}</td>
                    <td class="px-3 py-2">${item.qtyLarge}</td>
                    <td class="px-3 py-2">${item.qtyXL}</td>
                    <td class="px-3 py-2">${item.palletL}</td>
                    <td class="px-3 py-2">${item.palletXL}</td>
                    <td class="px-3 py-2 font-medium">${item.totalQty}</td>
                    <td class="px-3 py-2 text-xs">${item.note}</td>
                    <td class="px-3 py-2"><button onclick="editItem(${i})" class="px-2 py-1 bg-blue-500 text-white rounded text-xs">Edit</button></td>
                </tr>
            `).join('');

            const totals = window.state.inventory.reduce((acc, item) => ({
                large: acc.large + (item.qtyLarge || 0),
                xl: acc.xl + (item.qtyXL || 0),
                palletL: acc.palletL + (item.palletL || 0),
                palletXL: acc.palletXL + (item.palletXL || 0)
            }), { large: 0, xl: 0, palletL: 0, palletXL: 0 });

            tbody.innerHTML += `
                <tr class="bg-indigo-50 font-bold border-t-2">
                    <td class="px-3 py-3" colspan="3">TOTAL</td>
                    <td class="px-3 py-3">${totals.large}</td>
                    <td class="px-3 py-3">${totals.xl}</td>
                    <td class="px-3 py-3">${totals.palletL}</td>
                    <td class="px-3 py-3">${totals.palletXL}</td>
                    <td class="px-3 py-3">${totals.large + totals.xl}</td>
                    <td class="px-3 py-3 text-xs">Pallets: ${totals.palletL + totals.palletXL}</td>
                    <td></td>
                </tr>
            `;
        };

        function handlePinSubmit() {
            if (document.getElementById('pinInput').value === '1107') {
                window.state.isAuthenticated = true;
                showMessage('‚úÖ Authenticated!', 'success');
                showStep('action');
            } else {
                showMessage('‚ùå Incorrect PIN', 'error');
            }
            document.getElementById('pinInput').value = '';
        }

        function selectAction(action) {
            window.state.currentAction = action;
            showStep(action === 'add' ? 'lotNumber' : 'delete');
        }

        function handleLotNumberSubmit() {
            window.state.lotNumber = document.getElementById('lotNumberInput').value.trim();
            if (window.state.lotNumber) showStep('size');
        }

        function handleSizeSubmit() {
            window.state.size = document.getElementById('sizeInput').value;
            if (window.state.size) showStep('pallet');
        }

        function handlePalletSubmit() {
            window.state.palletAmount = document.getElementById('palletInput').value;
            if (window.state.palletAmount && parseInt(window.state.palletAmount) > 0) {
                showStep('completed');
            } else {
                showMessage('Invalid pallet amount', 'error');
            }
        }

        function handleCompletedSubmit() {
            const completed = document.getElementById('completedInput').value.toLowerCase();
            if (completed === 'yes' || completed === 'no') {
                const pallets = parseInt(window.state.palletAmount);
                const qty = pallets * 1800;
                const idx = window.state.inventory.findIndex(item => item.lotNumber === window.state.lotNumber);
                const note = completed === 'no' ? 'not completed' : '';
                
                if (idx !== -1) {
                    const isLarge = window.state.size.toLowerCase() === 'large' || window.state.size.toLowerCase() === 'l';
                    if (isLarge) {
                        window.state.inventory[idx].qtyLarge += qty;
                        window.state.inventory[idx].palletL += pallets;
                    } else {
                        window.state.inventory[idx].qtyXL += qty;
                        window.state.inventory[idx].palletXL += pallets;
                    }
                    window.state.inventory[idx].totalQty = window.state.inventory[idx].qtyLarge + window.state.inventory[idx].qtyXL;
                    window.state.inventory[idx].note = note;
                } else {
                    const { mfgDate, useByDate } = parseLotNumberDates(window.state.lotNumber);
                    const isLarge = window.state.size.toLowerCase() === 'large' || window.state.size.toLowerCase() === 'l';
                    window.state.inventory.push({
                        lotNumber: window.state.lotNumber,
                        mfgDate,
                        useByDate,
                        qtyLarge: isLarge ? qty : 0,
                        qtyXL: isLarge ? 0 : qty,
                        palletL: isLarge ? pallets : 0,
                        palletXL: isLarge ? 0 : pallets,
                        totalQty: qty,
                        note,
                        shipDate: '',
                        trackingNumber: '',
                        destination: ''
                    });
                }
                
                window.saveToFirebase();
                resetForm();
                showMessage('‚úÖ Saved!', 'success');
                showStep('action');
            } else {
                showMessage('Please enter Yes or No', 'error');
            }
        }

        function handleDeleteLotSubmit() {
            window.state.deleteLotNumber = document.getElementById('deleteLotInput').value.trim();
            const idx = window.state.inventory.findIndex(item => item.lotNumber.toUpperCase() === window.state.deleteLotNumber.toUpperCase());
            if (idx === -1) {
                showMessage('Lot not found', 'error');
            } else {
                showStep('deleteSize');
            }
        }

        function handleDeleteSizeSubmit() {
            window.state.deleteSize = document.getElementById('deleteSizeInput').value;
            if (window.state.deleteSize) showStep('deletePallet');
        }

        function handleDeletePalletSubmit() {
            const pallets = parseInt(document.getElementById('deletePalletInput').value);
            if (!pallets || pallets <= 0) {
                showMessage('Invalid pallet amount', 'error');
                return;
            }

            const qty = pallets * 1800;
            const idx = window.state.inventory.findIndex(item => item.lotNumber.toUpperCase() === window.state.deleteLotNumber.toUpperCase());
            
            if (idx !== -1) {
                const isLarge = window.state.deleteSize.toLowerCase() === 'large' || window.state.deleteSize.toLowerCase() === 'l';
                if (isLarge) {
                    window.state.inventory[idx].qtyLarge = Math.max(0, window.state.inventory[idx].qtyLarge - qty);
                    window.state.inventory[idx].palletL = Math.max(0, window.state.inventory[idx].palletL - pallets);
                } else {
                    window.state.inventory[idx].qtyXL = Math.max(0, window.state.inventory[idx].qtyXL - qty);
                    window.state.inventory[idx].palletXL = Math.max(0, window.state.inventory[idx].palletXL - pallets);
                }
                window.state.inventory[idx].totalQty = window.state.inventory[idx].qtyLarge + window.state.inventory[idx].qtyXL;
                
                if (window.state.inventory[idx].qtyLarge === 0 && window.state.inventory[idx].qtyXL === 0) {
                    window.state.inventory.splice(idx, 1);
                }
                
                window.saveToFirebase();
                resetDeleteForm();
                showMessage('‚úÖ Removed!', 'success');
                showStep('action');
            }
        }

        function goBack() {
            if (window.state.currentStep === 'size') showStep('lotNumber');
            else if (window.state.currentStep === 'pallet') showStep('size');
            else if (window.state.currentStep === 'completed') showStep('pallet');
        }

        function goBackDelete() {
            if (window.state.currentStep === 'deleteSize') showStep('delete');
            else if (window.state.currentStep === 'deletePallet') showStep('deleteSize');
        }

        function resetForm() {
            window.state.lotNumber = '';
            window.state.size = '';
            window.state.palletAmount = '';
            window.state.isCompleted = '';
            document.getElementById('lotNumberInput').value = '';
            document.getElementById('sizeInput').value = '';
            document.getElementById('palletInput').value = '';
            document.getElementById('completedInput').value = '';
        }

        function resetDeleteForm() {
            window.state.deleteLotNumber = '';
            window.state.deleteSize = '';
            window.state.deletePalletAmount = '';
            document.getElementById('deleteLotInput').value = '';
            document.getElementById('deleteSizeInput').value = '';
            document.getElementById('deletePalletInput').value = '';
        }

        function editItem(i) {
            const item = window.state.inventory[i];
            const row = event.target.closest('tr');
            row.innerHTML = `
                <td class="px-3 py-2">${item.lotNumber}</td>
                <td class="px-3 py-2">${item.mfgDate}</td>
                <td class="px-3 py-2">${item.useByDate}</td>
                <td class="px-3 py-2"><input type="number" id="e-l-${i}" value="${item.qtyLarge}" class="w-20 px-2 py-1 border rounded"></td>
                <td class="px-3 py-2"><input type="number" id="e-xl-${i}" value="${item.qtyXL}" class="w-20 px-2 py-1 border rounded"></td>
                <td class="px-3 py-2"><input type="number" id="e-pl-${i}" value="${item.palletL}" class="w-20 px-2 py-1 border rounded"></td>
                <td class="px-3 py-2"><input type="number" id="e-pxl-${i}" value="${item.palletXL}" class="w-20 px-2 py-1 border rounded"></td>
                <td class="px-3 py-2">${item.totalQty}</td>
                <td class="px-3 py-2"><input type="text" id="e-note-${i}" value="${item.note}" class="w-24 px-2 py-1 border rounded text-xs"></td>
                <td class="px-3 py-2">
                    <button onclick="saveEdit(${i})" class="px-2 py-1 bg-green-500 text-white rounded text-xs mr-1">Save</button>
                    <button onclick="renderTable()" class="px-2 py-1 bg-gray-500 text-white rounded text-xs">Cancel</button>
                </td>
            `;
        }

        function saveEdit(i) {
            window.state.inventory[i].qtyLarge = parseInt(document.getElementById(`e-l-${i}`).value) || 0;
            window.state.inventory[i].qtyXL = parseInt(document.getElementById(`e-xl-${i}`).value) || 0;
            window.state.inventory[i].palletL = parseInt(document.getElementById(`e-pl-${i}`).value) || 0;
            window.state.inventory[i].palletXL = parseInt(document.getElementById(`e-pxl-${i}`).value) || 0;
            window.state.inventory[i].note = document.getElementById(`e-note-${i}`).value;
            window.state.inventory[i].totalQty = window.state.inventory[i].qtyLarge + window.state.inventory[i].qtyXL;
            window.saveToFirebase();
            showMessage('‚úÖ Updated!', 'success');
            window.renderTable();
        }

        function clearAllInventory() {
            if (confirm('‚ö†Ô∏è Delete ALL data?') && confirm('‚ö†Ô∏è Final confirmation?')) {
                window.state.inventory = [];
                window.saveToFirebase();
                showMessage('‚úÖ Cleared!', 'success');
            }
        }

        function downloadCSV() {
            const headers = ['Lot Number', 'Mfg Date', 'Use-By Date', 'Qty Large', 'Qty XL', 'Pallet L', 'Pallet XL', 'Total Qty', 'Note'];
            const csv = [headers.join(','), ...window.state.inventory.map(r => 
                [r.lotNumber, r.mfgDate, r.useByDate, r.qtyLarge, r.qtyXL, r.palletL, r.palletXL, r.totalQty, `"${r.note}"`].join(',')
            )].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        document.getElementById('logoutBtn').onclick = function() {
            window.state.isAuthenticated = false;
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('inventorySection').classList.add('hidden');
            showStep('pin');
        };
    </script>
</body>
</html>
