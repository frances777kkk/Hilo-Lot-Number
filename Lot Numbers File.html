<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isolation Gown Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <div id="app" class="p-8">
        <div class="max-w-5xl mx-auto">
            <!-- Main Card -->
            <div class="bg-white rounded-lg shadow-xl p-8 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        <h1 class="text-3xl font-bold text-gray-800">Isolation Gown Inventory Manager</h1>
                    </div>
                    <button id="logoutBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition hidden">
                        Logout (退出)
                    </button>
                </div>

                <!-- Message Box -->
                <div id="messageBox" class="hidden mb-4 p-4 rounded-lg flex items-center gap-2"></div>

                <!-- PIN Entry -->
                <div id="pinStep" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Enter PIN Code (输入PIN码)</label>
                        <input type="password" id="pinInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter PIN" autofocus>
                    </div>
                    <button onclick="handlePinSubmit()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                        Submit (提交)
                    </button>
                </div>

                <!-- Lot Number Step -->
                <div id="lotNumberStep" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lot Number (批次号)</label>
                        <input type="text" id="lotNumberInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="e.g., HX26010501">
                    </div>
                    <button onclick="handleLotNumberSubmit()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                        Next (下一步)
                    </button>
                </div>

                <!-- Size Step -->
                <div id="sizeStep" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Size (尺寸): Large or Extra Large</label>
                        <input type="text" id="sizeInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter L or XL">
                    </div>
                    <div class="flex gap-3">
                        <button onclick="goBack()" class="w-1/3 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-medium">
                            Back (后退)
                        </button>
                        <button onclick="handleSizeSubmit()" class="w-2/3 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                            Next (下一步)
                        </button>
                    </div>
                </div>

                <!-- Pallet Amount Step -->
                <div id="palletStep" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Amount of Pallets (托盘数量)</label>
                        <input type="number" id="palletInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter number of pallets">
                    </div>
                    <div class="flex gap-3">
                        <button onclick="goBack()" class="w-1/3 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-medium">
                            Back (后退)
                        </button>
                        <button onclick="handlePalletSubmit()" class="w-2/3 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                            Next (下一步)
                        </button>
                    </div>
                </div>

                <!-- Completed Step -->
                <div id="completedStep" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Is it completed? (是否完成?) Yes/No</label>
                        <input type="text" id="completedInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter Yes or No">
                    </div>
                    <div class="flex gap-3">
                        <button onclick="goBack()" class="w-1/3 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-medium">
                            Back (后退)
                        </button>
                        <button onclick="handleCompletedSubmit()" class="w-2/3 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                            Update Inventory (更新库存)
                        </button>
                    </div>
                </div>

                <!-- Continue Step -->
                <div id="continueStep" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Continue adding? (继续添加?) Yes/No</label>
                        <input type="text" id="continueInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter Yes or No">
                    </div>
                    <div class="flex gap-3">
                        <button onclick="goBack()" class="w-1/3 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-medium">
                            Back (后退)
                        </button>
                        <button onclick="handleContinueSubmit()" class="w-2/3 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                            Submit (提交)
                        </button>
                    </div>
                </div>

                <!-- Done Step -->
                <div id="doneStep" class="text-center space-y-4 hidden">
                    <svg class="w-16 h-16 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-xl font-medium text-gray-800">All updates completed! (所有更新已完成！)</p>
                    <div class="flex gap-3 justify-center flex-wrap">
                        <button onclick="downloadCSV()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download CSV (下载CSV)
                        </button>
                        <button onclick="copyToClipboard()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Copy to Clipboard (复制)
                        </button>
                        <button onclick="toggleExportData()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                            <span id="toggleText">Show Data (显示)</span>
                        </button>
                    </div>
                    <div id="copySuccessMsg" class="hidden p-3 bg-green-100 text-green-800 rounded-lg font-medium"></div>
                    <div id="exportDataBox" class="hidden mt-4 text-left">
                        <p class="text-sm text-gray-600 mb-2 font-medium">CSV Data - Click to select all, then Ctrl+C (Windows) or Cmd+C (Mac) to copy:</p>
                        <p class="text-sm text-gray-500 mb-2">(CSV数据 - 点击选择全部，然后 Ctrl+C 或 Cmd+C 复制)</p>
                        <textarea id="exportTextarea" readonly class="w-full h-96 p-4 border-2 border-indigo-300 rounded-lg font-mono text-xs bg-gray-50" onclick="this.select()"></textarea>
                    </div>
                </div>
            </div>

            <!-- Inventory Table -->
            <div id="inventorySection" class="bg-white rounded-lg shadow-xl p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Current Inventory (当前库存)</h2>
                    <div class="flex gap-2">
                        <button onclick="downloadCSV()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download (下载)
                        </button>
                        <button onclick="copyToClipboard()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Copy (复制)
                        </button>
                    </div>
                </div>
                <div id="tableSuccessMsg" class="hidden mb-3 p-3 bg-green-100 text-green-800 rounded-lg text-sm font-medium"></div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left">Lot Number</th>
                                <th class="px-3 py-2 text-left">Mfg Date</th>
                                <th class="px-3 py-2 text-left">Use-By Date</th>
                                <th class="px-3 py-2 text-left">Qty (L)</th>
                                <th class="px-3 py-2 text-left">Qty (XL)</th>
                                <th class="px-3 py-2 text-left">Pallet (L)</th>
                                <th class="px-3 py-2 text-left">Pallet (XL)</th>
                                <th class="px-3 py-2 text-left">Total Qty</th>
                                <th class="px-3 py-2 text-left">Note</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let state = {
            isAuthenticated: false,
            currentStep: 'pin',
            lotNumber: '',
            size: '',
            palletAmount: '',
            isCompleted: '',
            continueProcess: '',
            showExportData: false,
            inventory: [
                { lotNumber: 'HX25123101', mfgDate: '12/30/2025, 12/31/2025', useByDate: '12/30/2028, 12/31/2028', qtyLarge: 16200, qtyXL: 9000, palletL: 9, palletXL: 5, totalQty: 25200, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX25123102', mfgDate: '12/30/2025, 12/31/2025', useByDate: '12/30/2028, 12/31/2029', qtyLarge: 5400, qtyXL: 10800, palletL: 3, palletXL: 6, totalQty: 16200, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX25123103', mfgDate: '12/30/2025', useByDate: '12/30/2028', qtyLarge: 23400, qtyXL: 0, palletL: 13, palletXL: 0, totalQty: 23400, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX25113001', mfgDate: '11/30/2025', useByDate: '11/30/2028', qtyLarge: 10800, qtyXL: 0, palletL: 6, palletXL: 0, totalQty: 10800, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX25123104', mfgDate: '12/30/2025', useByDate: '12/30/2028', qtyLarge: 10800, qtyXL: 0, palletL: 6, palletXL: 0, totalQty: 10800, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX25123105', mfgDate: '12/30/2025', useByDate: '12/30/2028', qtyLarge: 10800, qtyXL: 0, palletL: 6, palletXL: 0, totalQty: 10800, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX25123106', mfgDate: '12/30/2025', useByDate: '12/30/2028', qtyLarge: 3600, qtyXL: 0, palletL: 2, palletXL: 0, totalQty: 3600, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX25122701', mfgDate: '12/31/2025', useByDate: '12/31/2028', qtyLarge: 3600, qtyXL: 0, palletL: 2, palletXL: 0, totalQty: 3600, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX25122901', mfgDate: '12/31/2025', useByDate: '12/31/2028', qtyLarge: 3600, qtyXL: 0, palletL: 2, palletXL: 0, totalQty: 3600, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX25122601', mfgDate: '12/31/2025', useByDate: '12/31/2028', qtyLarge: 5400, qtyXL: 0, palletL: 3, palletXL: 0, totalQty: 5400, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX25123001', mfgDate: '12/31/2025', useByDate: '12/31/2028', qtyLarge: 3600, qtyXL: 0, palletL: 2, palletXL: 0, totalQty: 3600, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX26010501', mfgDate: '1/31/2026', useByDate: '1/31/2029', qtyLarge: 1800, qtyXL: 0, palletL: 1, palletXL: 0, totalQty: 1800, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX26010601', mfgDate: '1/31/2026', useByDate: '1/31/2029', qtyLarge: 1800, qtyXL: 0, palletL: 1, palletXL: 0, totalQty: 1800, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX26010301', mfgDate: '1/31/2026', useByDate: '1/31/2029', qtyLarge: 3600, qtyXL: 0, palletL: 2, palletXL: 0, totalQty: 3600, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX26010201', mfgDate: '1/31/2026', useByDate: '1/31/2029', qtyLarge: 3600, qtyXL: 0, palletL: 2, palletXL: 0, totalQty: 3600, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX26010701', mfgDate: '1/31/2026', useByDate: '1/31/2029', qtyLarge: 9000, qtyXL: 0, palletL: 5, palletXL: 0, totalQty: 9000, note: 'one more pallet in progress', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX26010901', mfgDate: '1/31/2026', useByDate: '1/31/2029', qtyLarge: 5400, qtyXL: 0, palletL: 3, palletXL: 0, totalQty: 5400, note: '', shipDate: '', trackingNumber: '', destination: '' },
                { lotNumber: 'HX26010602', mfgDate: '1/31/2026', useByDate: '1/31/2029', qtyLarge: 0, qtyXL: 3600, palletL: 0, palletXL: 2, totalQty: 3600, note: '', shipDate: '', trackingNumber: '', destination: '' }
            ]
        };

        // Utility functions
        function showMessage(msg, type) {
            const box = document.getElementById('messageBox');
            box.className = `mb-4 p-4 rounded-lg flex items-center gap-2 ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            box.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    ${type === 'success' 
                        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
                        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
                    }
                </svg>
                <span>${msg}</span>
            `;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 5000);
        }

        function showStep(step) {
            ['pinStep', 'lotNumberStep', 'sizeStep', 'palletStep', 'completedStep', 'continueStep', 'doneStep'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(step + 'Step').classList.remove('hidden');
            
            if (step !== 'pin') {
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('inventorySection').classList.remove('hidden');
                renderTable();
            }
            
            // Focus on input
            setTimeout(() => {
                const inputs = {
                    'pin': 'pinInput',
                    'lotNumber': 'lotNumberInput',
                    'size': 'sizeInput',
                    'pallet': 'palletInput',
                    'completed': 'completedInput',
                    'continue': 'continueInput'
                };
                if (inputs[step]) {
                    document.getElementById(inputs[step]).focus();
                }
            }, 100);
        }

        function parseLotNumberDates(lotNum) {
            if (lotNum.length < 8) return { mfgDate: '', useByDate: '' };
            
            const yearPart = lotNum.substring(2, 4);
            const monthPart = lotNum.substring(4, 6);
            
            const year = 2000 + parseInt(yearPart);
            const month = parseInt(monthPart);
            
            const lastDay = new Date(year, month, 0).getDate();
            
            const mfgDate = `${month}/${lastDay}/${year}`;
            const useByYear = year + 3;
            const useByDate = `${month}/${lastDay}/${useByYear}`;
            
            return { mfgDate, useByDate };
        }

        function renderTable() {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = state.inventory.map(item => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-3 py-2 font-medium">${item.lotNumber}</td>
                    <td class="px-3 py-2">${item.mfgDate}</td>
                    <td class="px-3 py-2">${item.useByDate}</td>
                    <td class="px-3 py-2">${item.qtyLarge}</td>
                    <td class="px-3 py-2">${item.qtyXL}</td>
                    <td class="px-3 py-2">${item.palletL}</td>
                    <td class="px-3 py-2">${item.palletXL}</td>
                    <td class="px-3 py-2 font-medium">${item.totalQty}</td>
                    <td class="px-3 py-2 text-xs">${item.note}</td>
                </tr>
            `).join('');
        }

        function generateCSV() {
            const headers = ['Lot Number', 'Mfg Date', 'Use-By Date', 'Qty Large', 'Qty XL', 'Pallet L', 'Pallet XL', 'Total Qty', 'Note', 'Ship Date', 'Tracking Number', 'Destination'];
            const csvContent = [
                headers.join(','),
                ...state.inventory.map(row => [
                    row.lotNumber,
                    `"${row.mfgDate}"`,
                    `"${row.useByDate}"`,
                    row.qtyLarge,
                    row.qtyXL,
                    row.palletL,
                    row.palletXL,
                    row.totalQty,
                    `"${row.note}"`,
                    `"${row.shipDate}"`,
                    `"${row.trackingNumber}"`,
                    `"${row.destination}"`
                ].join(','))
            ].join('\n');
            return csvContent;
        }

        // Event handlers
        function handlePinSubmit() {
            const pin = document.getElementById('pinInput').value;
            if (pin === '1107') {
                state.isAuthenticated = true;
                state.currentStep = 'lotNumber';
                showMessage('Authentication successful! (验证成功！)', 'success');
                showStep('lotNumber');
                document.getElementById('pinInput').value = '';
            } else {
                showMessage('Incorrect PIN. Please try again. (PIN码错误，请重试)', 'error');
                document.getElementById('pinInput').value = '';
            }
        }

        function handleLotNumberSubmit() {
            state.lotNumber = document.getElementById('lotNumberInput').value.trim();
            if (state.lotNumber) {
                state.currentStep = 'size';
                showStep('size');
            }
        }

        function handleSizeSubmit() {
            state.size = document.getElementById('sizeInput').value;
            if (state.size) {
                state.currentStep = 'pallet';
                showStep('pallet');
            }
        }

        function handlePalletSubmit() {
            state.palletAmount = document.getElementById('palletInput').value;
            if (state.palletAmount && !isNaN(state.palletAmount) && parseInt(state.palletAmount) > 0) {
                state.currentStep = 'completed';
                showStep('completed');
            } else {
                showMessage('Please enter a valid pallet amount. (请输入有效的托盘数量)', 'error');
            }
        }

        function handleCompletedSubmit() {
            state.isCompleted = document.getElementById('completedInput').value;
            if (state.isCompleted.toLowerCase() === 'yes' || state.isCompleted.toLowerCase() === 'no') {
                updateInventory();
                state.currentStep = 'continue';
                showStep('continue');
            } else {
                showMessage('Please enter "Yes" or "No". (请输入 "Yes" 或 "No")', 'error');
            }
        }

        function updateInventory() {
            const pallets = parseInt(state.palletAmount);
            const qtyPerPallet = 1800;
            const totalQty = pallets * qtyPerPallet;
            
            const existingIndex = state.inventory.findIndex(item => item.lotNumber === state.lotNumber);
            const noteText = state.isCompleted.toLowerCase() === 'no' ? 'not completed' : '';
            
            if (existingIndex !== -1) {
                if (state.size.toLowerCase() === 'large' || state.size.toLowerCase() === 'l') {
                    state.inventory[existingIndex].qtyLarge += totalQty;
                    state.inventory[existingIndex].palletL += pallets;
                } else if (state.size.toLowerCase() === 'extra large' || state.size.toLowerCase() === 'xl') {
                    state.inventory[existingIndex].qtyXL += totalQty;
                    state.inventory[existingIndex].palletXL += pallets;
                }
                state.inventory[existingIndex].totalQty = state.inventory[existingIndex].qtyLarge + state.inventory[existingIndex].qtyXL;
                state.inventory[existingIndex].note = noteText;
                
                showMessage(`Updated lot ${state.lotNumber} successfully! (批次 ${state.lotNumber} 更新成功！)`, 'success');
            } else {
                const { mfgDate, useByDate } = parseLotNumberDates(state.lotNumber);
                
                const newEntry = {
                    lotNumber: state.lotNumber,
                    mfgDate: mfgDate,
                    useByDate: useByDate,
                    qtyLarge: state.size.toLowerCase() === 'large' || state.size.toLowerCase() === 'l' ? totalQty : 0,
                    qtyXL: state.size.toLowerCase() === 'extra large' || state.size.toLowerCase() === 'xl' ? totalQty : 0,
                    palletL: state.size.toLowerCase() === 'large' || state.size.toLowerCase() === 'l' ? pallets : 0,
                    palletXL: state.size.toLowerCase() === 'extra large' || state.size.toLowerCase() === 'xl' ? pallets : 0,
                    totalQty: totalQty,
                    note: noteText,
                    shipDate: '',
                    trackingNumber: '',
                    destination: ''
                };
                state.inventory.push(newEntry);
                showMessage(`Added new lot ${state.lotNumber} successfully! (新批次 ${state.lotNumber} 添加成功！)`, 'success');
            }
            renderTable();
        }

        function handleContinueSubmit() {
            state.continueProcess = document.getElementById('continueInput').value;
            if (state.continueProcess.toLowerCase() === 'yes') {
                resetForm();
                state.currentStep = 'lotNumber';
                showMessage('Starting new entry... (开始新的录入...)', 'success');
                showStep('lotNumber');
            } else if (state.continueProcess.toLowerCase() === 'no') {
                showMessage('Process completed. (流程已完成)', 'success');
                state.currentStep = 'done';
                showStep('done');
            } else {
                showMessage('Please enter "Yes" or "No". (请输入 "Yes" 或 "No")', 'error');
            }
        }

        function resetForm() {
            state.lotNumber = '';
            state.size = '';
            state.palletAmount = '';
            state.isCompleted = '';
            state.continueProcess = '';
            document.getElementById('lotNumberInput').value = '';
            document.getElementById('sizeInput').value = '';
            document.getElementById('palletInput').value = '';
            document.getElementById('completedInput').value = '';
            document.getElementById('continueInput').value = '';
        }

        function goBack() {
            if (state.currentStep === 'size') {
                state.currentStep = 'lotNumber';
                showStep('lotNumber');
            } else if (state.currentStep === 'pallet') {
                state.currentStep = 'size';
                showStep('size');
            } else if (state.currentStep === 'completed') {
                state.currentStep = 'pallet';
                showStep('pallet');
            } else if (state.currentStep === 'continue') {
                state.currentStep = 'completed';
                showStep('completed');
            }
        }

        function downloadCSV() {
            try {
                const csvData = generateCSV();
                const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `inventory_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                const msg = document.getElementById('copySuccessMsg') || document.getElementById('tableSuccessMsg');
                if (msg) {
                    msg.textContent = '✓ File downloaded! Check your downloads folder. (文件已下载！检查下载文件夹)';
                    msg.classList.remove('hidden');
                    setTimeout(() => msg.classList.add('hidden'), 4000);
                }
            } catch (err) {
                showMessage('Download failed. Please try "Show Data" option. (下载失败，请使用"显示数据"选项)', 'error');
            }
        }

        async function copyToClipboard() {
            try {
                const csvData = generateCSV();
                await navigator.clipboard.writeText(csvData);
                
                const msg = document.getElementById('copySuccessMsg') || document.getElementById('tableSuccessMsg');
                if (msg) {
                    msg.textContent = '✓ Copied to clipboard! Paste into Excel. (已复制！可粘贴到Excel)';
                    msg.classList.remove('hidden');
                    setTimeout(() => msg.classList.add('hidden'), 4000);
                }
            } catch (err) {
                downloadCSV();
            }
        }

        function toggleExportData() {
            state.showExportData = !state.showExportData;
            const box = document.getElementById('exportDataBox');
            const toggleText = document.getElementById('toggleText');
            
            if (state.showExportData) {
                box.classList.remove('hidden');
                toggleText.textContent = 'Hide Data (隐藏)';
                document.getElementById('exportTextarea').value = generateCSV();
            } else {
                box.classList.add('hidden');
                toggleText.textContent = 'Show Data (显示)';
            }
        }

        // Logout
        document.getElementById('logoutBtn').onclick = function() {
            state.isAuthenticated = false;
            state.currentStep = 'pin';
            resetForm();
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('inventorySection').classList.add('hidden');
            document.getElementById('messageBox').classList.add('hidden');
            showStep('pin');
        };

        // Enter key handlers
        document.getElementById('pinInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handlePinSubmit();
        });
        document.getElementById('lotNumberInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLotNumberSubmit();
        });
        document.getElementById('sizeInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSizeSubmit();
        });
        document.getElementById('palletInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handlePalletSubmit();
        });
        document.getElementById('completedInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleCompletedSubmit();
        });
        document.getElementById('continueInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleContinueSubmit();
        });
    </script>
</body>
</html>